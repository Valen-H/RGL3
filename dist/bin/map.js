#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const mod = tslib_1.__importStar(require("../lib/rgl"));
const path = tslib_1.__importStar(require("path"));
const util = tslib_1.__importStar(require("util"));
let qtcn = false, Rgl, map, gout, cur = [0, 0];
function help() {
    return `Commands:
	h			-	Display this help screen
	d			-	Display Map
	c			-	Clear Screen
	s			-	Save Map
	l			-	Load Map
	r			-	Resize Map (Very Important to do first!!)
	t			-	Trim leftovers after resize
	ev[cd		-	Evaluate code
	ctrl-C/qt	-	Quit

Separate Commands with '.' (dot)`;
} //help
function move(x = cur[0], y = cur[1]) {
    cur[0] = Math.max(x, 0) % map.dimens[0];
    cur[1] = Math.max(y, 0) % map.dimens[1];
    return cur;
} //move
function moveBy(dx = 0, dy = 0) {
    return move(cur[0] + dx, cur[1] + dy);
} //moveBy
async function render() {
    await command('c');
    await map.stamp();
} //render
function pad(prev, n = map.dimens[0] * map.dimens[1], wild = false) {
    for (let i = prev; i < n; i++)
        if (!map.chunks[i])
            map.chunks.push(mod.rglm.RGLM.RGLMChunk.blank());
    prev = Math.min(map.chunks.length, prev);
    while (n < prev) {
        if (wild || !map.chunks[map.chunks.length - 1].chr) {
            map.chunks.pop();
            prev--;
        }
        else
            break;
    }
    command("d");
} //pad
function quit() {
    if (!qtcn) {
        Rgl.writeE("Press Quit again.");
        qtcn = true;
        setTimeout(() => (qtcn = false), 2000);
    }
    else {
        Rgl.writeE("Quit.");
        process.exit(1);
    }
} //quit
async function command(acc) {
    let comm = acc.split(/(?<!\\)\./gmi).map(c => c.replaceAll(/(?<!\\)\\/gmi, '').replaceAll("\\\\", "\\"));
    for (const com of comm) {
        const args = (com.match(/\[(.+)$/mis) || [])[1], noarg = com.replace(/\[.*$/mis, "");
        if (/^h(?:elp)?/is.test(com))
            Rgl.writeE(help());
        else if (/^d(?:is(?:p(?:l(?:ay)?)?)?)?/is.test(com))
            await render();
        else if (/^c(?:l(?:(?:ea)?[rn])?)?/is.test(com))
            await Rgl.clear();
        else if (/^e(?:v(?:a?l(?:uate)?)?)?/is.test(com)) {
            Rgl.writeE(util.inspect(await eval(args ?? "")));
        }
        else if (/^(?:q(?:(?:ui)?t)?|e(?:(?:xi)?t)?)/is.test(com))
            quit();
        else if (/^s(?:ave?|to?re?)?/is.test(com)) {
            await map.store(args);
            Rgl.writeE("Map saved.");
        }
        else if (/^(?:re?)?l(?:(?:oa)?d)?/is.test(com)) {
            map = await mod.rglm.RGLM.RGLMap.parse(args ?? gout, Rgl);
            Rgl.writeE("Map loaded.");
        }
        else if (/re?(?:s(?:i?ze?)?)?/is.test(com)) {
            if (args) {
                const s = args.split(',').map(n => Number(n)), prev = map.dimens[0] * map.dimens[1];
                map.dimens[0] = Math.max(typeof s[0] == "number" ? s[0] : map.dimens[0], 0);
                map.dimens[1] = Math.max(typeof s[1] == "number" ? s[1] : map.dimens[1], 0);
                pad(prev);
            }
            Rgl.writeE(`Size: ${map.dimens.join(", ")}\tCursor: ${cur.join(", ")}`);
        }
        else if (/^t(?:ri?m)?/is.test(com)) {
            const s = args ? args.split(',').map(n => Number(n)) : [];
            pad(typeof s[0] == "number" ? s[0] : map.chunks.length, typeof s[1] == "number" ? s[1] : (map.dimens[0] * map.dimens[1]), true);
        }
        else if (!noarg) {
            let c = mod.rglm.RGLM.RGLMChunk.blank();
            if (args) {
                const s = args.split(',');
                c.chr = s[0].toString().slice(0, 4) ?? '';
                c.fg = Math.max(Math.min(Number(s[1] ?? 0xff), 0xff), 0);
                c.bg = Math.max(Math.min(Number(s[2] ?? 0xff), 0xff), 0);
                c.st = Math.max(Math.min(Number(s[3] ?? 0xff), 0xff), 0);
                c.cust = Math.max(Math.min(Number(s[4] ?? 0xff), 0xff), 0);
            }
            map.place([c], ...cur);
            moveBy(1);
            command("d.r");
        }
    }
} //command
module.exports = async function Map(out, ...args) {
    console.info(`Writing: ${out ?? "map.rglm"}`);
    const mpg = /-{0,2}m(?:ap(?:pings?)?)?/.test(args[0]) ? args[1] : null;
    try {
        Rgl = await mod.rgl.RGL.load();
        if (mpg)
            Rgl.parseMappings(mpg);
    }
    catch (e) {
        Rgl = await mod.rgl.RGL.load({
            name: path.win32.basename(out ?? "map.rglm"),
            main: "main.js",
            description: "rgl map",
            version: "0.1.0",
            keywords: ["map", "make", "rgl"],
            mappings: mpg ?? "mappings.js"
        });
    }
    Rgl.capture();
    await Rgl.clear();
    try {
        map = await mod.rglm.RGLM.RGLMap.parse(gout = out ?? `map${Math.round(Math.random() * 0xffffffff)}.rglm`, Rgl);
    }
    catch (e) {
        map = mod.rglm.RGLM.RGLMap.blank(Rgl);
        map.parent = Rgl;
        map._loadedFrom = gout = `map${Math.round(Math.random() * 0xffffffff)}.rglm`;
    }
    Rgl.writeE(`Writing: ${gout}`);
    Rgl.writeE(help());
    let acc = "", history = [], histidx = 0, acidx = 0;
    Rgl.on("rawctrlkey", async (k, c, a, b) => {
        if (!mod.rgl.RGL.special_keys.ctrlC.compare(k))
            quit();
        else if (!mod.rgl.RGL.special_keys.enter.compare(k)) {
            if (!acc)
                return;
            await Rgl.clear(-1);
            await Rgl.move(0);
            await command(acc);
            history.push(acc);
            while (history.length > 100)
                history.shift();
            acc = "";
            acidx = histidx = 0;
        }
        else if (!mod.rgl.RGL.special_keys.back.compare(k)) {
            acc = acc.slice(0, acc.length - 1);
            await Rgl.move(-1, 0, true);
            Rgl.write(' ');
            await Rgl.move(-1, 0, true);
        }
        else if (!mod.rgl.RGL.special_keys.up.compare(k)) {
            moveBy(0, -1);
        }
        else if (!mod.rgl.RGL.special_keys.down.compare(k)) {
            moveBy(0, 1);
        }
        else if (!mod.rgl.RGL.special_keys.right.compare(k)) {
            moveBy(1, 0);
        }
        else if (!mod.rgl.RGL.special_keys.left.compare(k)) {
            moveBy(-1, 0);
        }
        else if (!mod.rgl.RGL.special_keys.shiftUp.compare(k)) {
            histidx = histidx <= history.length ? (histidx + 1) : histidx;
            acc = history[history.length - histidx] ?? acc;
            await Rgl.clear(-1);
            await Rgl.move(0);
            Rgl.write(acc);
        }
        else if (!mod.rgl.RGL.special_keys.shiftDown.compare(k)) {
            histidx = histidx > 0 ? (histidx - 1) : histidx;
            acc = history[history.length - histidx] ?? acc;
            await Rgl.clear(-1);
            await Rgl.move(0);
            Rgl.write(acc);
        }
        else {
            let s = b.toString();
            acc += s;
            Rgl.write(s);
            acidx++;
        }
    });
}; //map
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vYmluL21hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsWUFBWSxDQUFDOzs7QUFFYix3REFBa0M7QUFDbEMsbURBQTZCO0FBQzdCLG1EQUE2QjtBQUU3QixJQUFJLElBQUksR0FBWSxLQUFLLEVBQ3hCLEdBQWdCLEVBQ2hCLEdBQXlCLEVBQ3pCLElBQVksRUFDWixHQUFHLEdBQXFCLENBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBRSxDQUFDO0FBRWxDLFNBQVMsSUFBSTtJQUNaLE9BQU87Ozs7Ozs7Ozs7O2lDQVd5QixDQUFDO0FBQ2xDLENBQUMsQ0FBQyxNQUFNO0FBRVIsU0FBUyxJQUFJLENBQUMsSUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ25ELEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXhDLE9BQU8sR0FBRyxDQUFDO0FBQ1osQ0FBQyxDQUFDLE1BQU07QUFDUixTQUFTLE1BQU0sQ0FBQyxLQUFhLENBQUMsRUFBRSxLQUFhLENBQUM7SUFDN0MsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7QUFDdkMsQ0FBQyxDQUFDLFFBQVE7QUFFVixLQUFLLFVBQVUsTUFBTTtJQUNwQixNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNuQixNQUFNLEdB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RyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUU1RSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDVjtZQUVELEdBQUcsQ0FBQyxNQUFNLENBQUMsU0FBUyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN4RTthQUFNLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNyQyxNQUFNLENBQUMsR0FBYSxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUcsQ0FBQztZQUVyRSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ2hJO2FBQU0sSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNsQixJQUFJLENBQUMsR0FBNEIsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBRWpFLElBQUksSUFBSSxFQUFFO2dCQUNULE1BQU0sQ0FBQyxHQUE2QyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBNkMsQ0FBQztnQkFFaEgsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQzFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pELENBQUMsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pELENBQUMsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pELENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDM0Q7WUFFRCxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQztZQUN2QixNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDVixPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDZjtLQUNEO0FBQ0YsQ0FBQyxDQUFDLFNBQVM7QUFFWCxNQUFNLENBQUMsT0FBTyxHQUFHLEtBQUssVUFBVSxHQUFHLENBQUMsR0FBVyxFQUFFLEdBQUcsSUFBYztJQUNqRSxPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFFOUMsTUFBTSxHQUFHLEdBQXlCLDJCQUEyQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFFN0YsSUFBSTtRQUNILEdBQUcsR0FBRyxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRS9CLElBQUksR0FBRztZQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDaEM7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNYLEdBQUcsR0FBRyxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQztZQUM1QixJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLFVBQVUsQ0FBQztZQUM1QyxJQUFJLEVBQUUsU0FBUztZQUNmLFdBQVcsRUFBRSxTQUFTO1lBQ3RCLE9BQU8sRUFBRSxPQUFPO1lBQ2hCLFFBQVEsRUFBRSxDQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsS0FBSyxDQUFFO1lBQ2xDLFFBQVEsRUFBRSxHQUFHLElBQUksYUFBYTtTQUM5QixDQUFDLENBQUM7S0FDSDtJQUVELEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNkLE1BQU0sR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBRWxCLElBQUk7UUFDSCxHQUFHLEdBQUcsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxHQUFHLElBQUksTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxVQUFVLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0tBQy9HO0lBQUMsT0FBTSxDQUFDLEVBQUU7UUFDVixHQUFHLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0QyxHQUFHLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztRQUNqQixHQUFHLENBQUMsV0FBVyxHQUFHLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUM7S0FDN0U7SUFFRCxHQUFHLENBQUMsTUFBTSxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUMsQ0FBQztJQUMvQixHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7SUFFbkIsSUFBSSxHQUFHLEdBQVcsRUFBRSxFQUNuQixPQUFPLEdBQWEsRUFBRSxFQUN0QixPQUFPLEdBQVcsQ0FBQyxFQUNuQixLQUFLLEdBQVcsQ0FBQyxDQUFDO0lBRW5CLEdBQUcsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUN6QyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQUUsSUFBSSxFQUFFLENBQUM7YUFDbEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ3BELElBQUksQ0FBQyxHQUFHO2dCQUFFLE9BQU87WUFFakIsTUFBTSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRWxCLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRW5CLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDbEIsT0FBTyxPQUFPLENBQUMsTUFBTSxHQUFHLEdBQUc7Z0JBQUUsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBRTdDLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDVCxLQUFLLEdBQUcsT0FBTyxHQUFHLENBQUMsQ0FBQztTQUNwQjthQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNyRCxHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzVCLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDZixNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQzVCO2FBQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ25ELE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNkO2FBQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ3JELE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDYjthQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUN0RCxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ2I7YUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDckQsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ2Q7YUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDeEQsT0FBTyxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1lBRTlELEdBQUcsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsSUFBSSxHQUFHLENBQUM7WUFFL0MsTUFBTSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDZjthQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUMxRCxPQUFPLEdBQUcsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUVoRCxHQUFHLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLElBQUksR0FBRyxDQUFDO1lBRS9DLE1BQU0sR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQixHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2Y7YUFBTTtZQUNOLElBQUksQ0FBQyxHQUFXLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUM3QixHQUFHLElBQUksQ0FBQyxDQUFDO1lBQ1QsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNiLEtBQUssRUFBRSxDQUFDO1NBQ1I7SUFDRixDQUFDLENBQUMsQ0FBQztBQUNKLENBQUMsQ0FBQyxDQUFDLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXHJcblxyXG5cInVzZSBzdHJpY3RcIjtcclxuXHJcbmltcG9ydCAqIGFzIG1vZCBmcm9tIFwiLi4vbGliL3JnbFwiO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XHJcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSBcInV0aWxcIjtcclxuXHJcbmxldCBxdGNuOiBib29sZWFuID0gZmFsc2UsXHJcblx0UmdsOiBtb2QucmdsLlJHTCxcclxuXHRtYXA6IG1vZC5yZ2xtLlJHTE0uUkdMTWFwLFxyXG5cdGdvdXQ6IHN0cmluZyxcclxuXHRjdXI6IFtudW1iZXIsIG51bWJlcl0gPSBbIDAsIDAgXTtcclxuXHJcbmZ1bmN0aW9uIGhlbHAoKTogc3RyaW5nIHtcclxuXHRyZXR1cm4gYENvbW1hbmRzOlxyXG5cdGhcdFx0XHQtXHREaXNwbGF5IHRoaXMgaGVscCBzY3JlZW5cclxuXHRkXHRcdFx0LVx0RGlzcGxheSBNYXBcclxuXHRjXHRcdFx0LVx0Q2xlYXIgU2NyZWVuXHJcblx0c1x0XHRcdC1cdFNhdmUgTWFwXHJcblx0bFx0XHRcdC1cdExvYWQgTWFwXHJcblx0clx0XHRcdC1cdFJlc2l6ZSBNYXAgKFZlcnkgSW1wb3J0YW50IHRvIGRvIGZpcnN0ISEpXHJcblx0dFx0XHRcdC1cdFRyaW0gbGVmdG92ZXJzIGFmdGVyIHJlc2l6ZVxyXG5cdGV2W2NkXHRcdC1cdEV2YWx1YXRlIGNvZGVcclxuXHRjdHJsLUMvcXRcdC1cdFF1aXRcclxuXHJcblNlcGFyYXRlIENvbW1hbmRzIHdpdGggJy4nIChkb3QpYDtcclxufSAvL2hlbHBcclxuXHJcbmZ1bmN0aW9uIG1vdmUoeDogbnVtYmVyID0gY3VyWzBdLCB5OiBudW1iZXIgPSBjdXJbMV0pIHtcclxuXHRjdXJbMF0gPSBNYXRoLm1heCh4LCAwKSAlIG1hcC5kaW1lbnNbMF07XHJcblx0Y3VyWzFdID0gTWF0aC5tYXgoeSwgMCkgJSBtYXAuZGltZW5zWzFdO1xyXG5cdFxyXG5cdHJldHVybiBjdXI7XHJcbn0gLy9tb3ZlXHJcbmZ1bmN0aW9uIG1vdmVCeShkeDogbnVtYmVyID0gMCwgZHk6IG51bWJlciA9IDApIHtcclxuXHRyZXR1cm4gbW92ZShjdXJbMF0gKyBkeCwgY3VyWzFdICsgZHkpO1xyXG59IC8vbW92ZUJ5XHJcblxyXG5hc3luYyBmdW5jdGlvbiByZW5kZXIoKSB7XHJcblx0YXdhaXQgY29tbWFuZCgnYycpO1xyXG5cdGF3YWl0IG1hcC5zdGFtcCgpO1xyXG59IC8vcmVuZGVyXHJcblxyXG5mdW5jdGlvbiBwYWQocHJldjogbnVtYmVyLCBuOiBudW1iZXIgPSBtYXAuZGltZW5zWzBdICogbWFwLmRpbWVuc1sxXSwgd2lsZDogYm9vbGVhbiA9IGZhbHNlKSB7XHJcblx0Zm9yIChsZXQgaTogbnVtYmVyID0gcHJldjsgaSA8IG47IGkrKylcclxuXHRcdGlmICghbWFwLmNodW5rc1tpXSkgbWFwLmNodW5rcy5wdXNoKG1vZC5yZ2xtLlJHTE0uUkdMTUNodW5rLmJsYW5rKCkpO1xyXG5cdFxyXG5cdHByZXYgPSBNYXRoLm1pbihtYXAuY2h1bmtzLmxlbmd0aCwgcHJldik7XHJcblx0XHJcblx0d2hpbGUgKG4gPCBwcmV2KSB7XHJcblx0XHRpZiAod2lsZCB8fCAhbWFwLmNodW5rc1ttYXAuY2h1bmtzLmxlbmd0aCAtIDFdLmNocikge1xyXG5cdFx0XHRtYXAuY2h1bmtzLnBvcCgpO1xyXG5cdFx0XHRwcmV2LS07XHJcblx0XHR9IGVsc2UgYnJlYWs7XHJcblx0fVxyXG5cdFxyXG5cdGNvbW1hbmQoXCJkXCIpO1xyXG59IC8vcGFkXHJcblxyXG5mdW5jdGlvbiBxdWl0KCk6IHZvaWQge1xyXG5cdGlmICghcXRjbikge1xyXG5cdFx0UmdsLndyaXRlRShcIlByZXNzIFF1aXQgYWdhaW4uXCIpO1xyXG5cdFx0cXRjbiA9IHRydWU7XHJcblx0XHRzZXRUaW1lb3V0KCgpID0+IChxdGNuID0gZmFsc2UpLCAyMDAwKTtcclxuXHR9IGVsc2Uge1xyXG5cdFx0UmdsLndyaXRlRShcIlF1aXQuXCIpO1xyXG5cdFx0cHJvY2Vzcy5leGl0KDEpO1xyXG5cdH1cclxufSAvL3F1aXRcclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGNvbW1hbmQoYWNjOiBzdHJpbmcpIHtcclxuXHRsZXQgY29tbTogc3RyaW5nW10gPSBhY2Muc3BsaXQoLyg/PCFcXFxcKVxcLi9nbWkpLm1hcChjID0+IGMucmVwbGFjZUFsbCgvKD88IVxcXFwpXFxcXC9nbWksICcnKS5yZXBsYWNlQWxsKFwiXFxcXFxcXFxcIiwgXCJcXFxcXCIpKTtcclxuXHRcclxuXHRmb3IgKGNvbnN0IGNvbSBvZiBjb21tKSB7XHJcblx0XHRjb25zdCBhcmdzOiBzdHJpbmcgPSAoY29tLm1hdGNoKC9cXFsoLispJC9taXMpIHx8IFsgXSlbMV0sXHJcblx0XHRcdG5vYXJnOiBzdHJpbmcgPSBjb20ucmVwbGFjZSgvXFxbLiokL21pcywgXCJcIik7XHJcblx0XHRcclxuXHRcdGlmICgvXmgoPzplbHApPy9pcy50ZXN0KGNvbSkpIFJnbC53cml0ZUUoaGVscCgpKTtcclxuXHRcdGVsc2UgaWYgKC9eZCg/OmlzKD86cCg/OmwoPzpheSk/KT8pPyk/L2lzLnRlc3QoY29tKSkgYXdhaXQgcmVuZGVyKCk7XHJcblx0XHRlbHNlIGlmICgvXmMoPzpsKD86KD86ZWEpP1tybl0pPyk/L2lzLnRlc3QoY29tKSkgYXdhaXQgUmdsLmNsZWFyKCk7XHJcblx0XHRlbHNlIGlmICgvXmUoPzp2KD86YT9sKD86dWF0ZSk/KT8pPy9pcy50ZXN0KGNvbSkpIHtcclxuXHRcdFx0UmdsLndyaXRlRSh1dGlsLmluc3BlY3QoYXdhaXQgZXZhbChhcmdzID8/IFwiXCIpKSk7XHJcblx0XHR9IGVsc2UgaWYgKC9eKD86cSg/Oig/OnVpKT90KT98ZSg/Oig/OnhpKT90KT8pL2lzLnRlc3QoY29tKSkgcXVpdCgpO1xyXG5cdFx0ZWxzZSBpZiAoL15zKD86YXZlP3x0bz9yZT8pPy9pcy50ZXN0KGNvbSkpIHtcclxuXHRcdFx0YXdhaXQgbWFwLnN0b3JlKGFyZ3MpO1xyXG5cdFx0XHRSZ2wud3JpdGVFKFwiTWFwIHNhdmVkLlwiKTtcclxuXHRcdH0gZWxzZSBpZiAoL14oPzpyZT8pP2woPzooPzpvYSk/ZCk/L2lzLnRlc3QoY29tKSkge1xyXG5cdFx0XHRtYXAgPSBhd2FpdCBtb2QucmdsbS5SR0xNLlJHTE1hcC5wYXJzZShhcmdzID8/IGdvdXQsIFJnbCk7XHJcblx0XHRcdFJnbC53cml0ZUUoXCJNYXAgbG9hZGVkLlwiKTtcclxuXHRcdH0gZWxzZSBpZiAoL3JlPyg/OnMoPzppP3plPyk/KT8vaXMudGVzdChjb20pKSB7XHJcblx0XHRcdGlmIChhcmdzKSB7XHJcblx0XHRcdFx0Y29uc3QgczogbnVtYmVyW10gPSBhcmdzLnNwbGl0KCcsJykubWFwKG4gPT4gTnVtYmVyKG4pKSxcclxuXHRcdFx0XHRcdHByZXY6IG51bWJlciA9IG1hcC5kaW1lbnNbMF0gKiBtYXAuZGltZW5zWzFdO1xyXG5cdFx0XHRcdFxyXG5cdFx0XHRcdG1hcC5kaW1lbnNbMF0gPSBNYXRoLm1heCh0eXBlb2Ygc1swXSA9PSBcIm51bWJlclwiID8gc1swXSA6IG1hcC5kaW1lbnNbMF0sIDApO1xyXG5cdFx0XHRcdG1hcC5kaW1lbnNbMV0gPSBNYXRoLm1heCh0eXBlb2Ygc1sxXSA9PSBcIm51bWJlclwiID8gc1sxXSA6IG1hcC5kaW1lbnNbMV0sIDApO1xyXG5cdFx0XHRcdFxyXG5cdFx0XHRcdHBhZChwcmV2KTtcclxuXHRcdFx0fVxyXG5cdFx0XHRcclxuXHRcdFx0UmdsLndyaXRlRShgU2l6ZTogJHttYXAuZGltZW5zLmpvaW4oXCIsIFwiKX1cXHRDdXJzb3I6ICR7Y3VyLmpvaW4oXCIsIFwiKX1gKTtcclxuXHRcdH0gZWxzZSBpZiAoL150KD86cmk/bSk/L2lzLnRlc3QoY29tKSkge1xyXG5cdFx0XHRjb25zdCBzOiBudW1iZXJbXSA9IGFyZ3MgPyBhcmdzLnNwbGl0KCcsJykubWFwKG4gPT4gTnVtYmVyKG4pKSA6IFsgXTtcclxuXHRcdFx0XHJcblx0XHRcdHBhZCh0eXBlb2Ygc1swXSA9PSBcIm51bWJlclwiID8gc1swXSA6IG1hcC5jaHVua3MubGVuZ3RoLCB0eXBlb2Ygc1sxXSA9PSBcIm51bWJlclwiID8gc1sxXSA6IChtYXAuZGltZW5zWzBdICogbWFwLmRpbWVuc1sxXSksIHRydWUpO1xyXG5cdFx0fSBlbHNlIGlmICghbm9hcmcpIHtcclxuXHRcdFx0bGV0IGM6IG1vZC5yZ2xtLlJHTE0uUkdMTUNodW5rID0gbW9kLnJnbG0uUkdMTS5SR0xNQ2h1bmsuYmxhbmsoKTtcclxuXHRcdFx0XHJcblx0XHRcdGlmIChhcmdzKSB7XHJcblx0XHRcdFx0Y29uc3QgczogW3N0cmluZywgbnVtYmVyLCBudW1iZXIsIG51bWJlciwgbnVtYmVyXSA9IGFyZ3Muc3BsaXQoJywnKSBhcyBbc3RyaW5nLCBudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdO1xyXG5cdFx0XHRcdFxyXG5cdFx0XHRcdGMuY2hyXHQ9IHNbMF0udG9TdHJpbmcoKS5zbGljZSgwLCA0KSA/PyAnJztcclxuXHRcdFx0XHRjLmZnXHQ9IE1hdGgubWF4KE1hdGgubWluKE51bWJlcihzWzFdID8/IDB4ZmYpLCAweGZmKSwgMCk7XHJcblx0XHRcdFx0Yy5iZ1x0PSBNYXRoLm1heChNYXRoLm1pbihOdW1iZXIoc1syXSA/PyAweGZmKSwgMHhmZiksIDApO1xyXG5cdFx0XHRcdGMuc3RcdD0gTWF0aC5tYXgoTWF0aC5taW4oTnVtYmVyKHNbM10gPz8gMHhmZiksIDB4ZmYpLCAwKTtcclxuXHRcdFx0XHRjLmN1c3RcdD0gTWF0aC5tYXgoTWF0aC5taW4oTnVtYmVyKHNbNF0gPz8gMHhmZiksIDB4ZmYpLCAwKTtcclxuXHRcdFx0fVxyXG5cdFx0XHRcclxuXHRcdFx0bWFwLnBsYWNlKFtjXSwgLi4uY3VyKTtcclxuXHRcdFx0bW92ZUJ5KDEpO1xyXG5cdFx0XHRjb21tYW5kKFwiZC5yXCIpO1xyXG5cdFx0fVxyXG5cdH1cclxufSAvL2NvbW1hbmRcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gYXN5bmMgZnVuY3Rpb24gTWFwKG91dDogc3RyaW5nLCAuLi5hcmdzOiBzdHJpbmdbXSkge1xyXG5cdGNvbnNvbGUuaW5mbyhgV3JpdGluZzogJHtvdXQgPz8gXCJtYXAucmdsbVwifWApO1xyXG5cdFxyXG5cdGNvbnN0IG1wZzogbW9kLk51bGxhYmxlPHN0cmluZz4gPSAvLXswLDJ9bSg/OmFwKD86cGluZ3M/KT8pPy8udGVzdChhcmdzWzBdKSA/IGFyZ3NbMV0gOiBudWxsO1xyXG5cdFxyXG5cdHRyeSB7XHJcblx0XHRSZ2wgPSBhd2FpdCBtb2QucmdsLlJHTC5sb2FkKCk7XHJcblx0XHRcclxuXHRcdGlmIChtcGcpIFJnbC5wYXJzZU1hcHBpbmdzKG1wZyk7XHJcblx0fSBjYXRjaCAoZSkge1xyXG5cdFx0UmdsID0gYXdhaXQgbW9kLnJnbC5SR0wubG9hZCh7XHJcblx0XHRcdG5hbWU6IHBhdGgud2luMzIuYmFzZW5hbWUob3V0ID8/IFwibWFwLnJnbG1cIiksXHJcblx0XHRcdG1haW46IFwibWFpbi5qc1wiLFxyXG5cdFx0XHRkZXNjcmlwdGlvbjogXCJyZ2wgbWFwXCIsXHJcblx0XHRcdHZlcnNpb246IFwiMC4xLjBcIixcclxuXHRcdFx0a2V5d29yZHM6IFsgXCJtYXBcIiwgXCJtYWtlXCIsIFwicmdsXCIgXSxcclxuXHRcdFx0bWFwcGluZ3M6IG1wZyA/PyBcIm1hcHBpbmdzLmpzXCJcclxuXHRcdH0pO1xyXG5cdH1cclxuXHRcclxuXHRSZ2wuY2FwdHVyZSgpO1xyXG5cdGF3YWl0IFJnbC5jbGVhcigpO1xyXG5cdFxyXG5cdHRyeSB7XHJcblx0XHRtYXAgPSBhd2FpdCBtb2QucmdsbS5SR0xNLlJHTE1hcC5wYXJzZShnb3V0ID0gb3V0ID8/IGBtYXAke01hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIDB4ZmZmZmZmZmYpfS5yZ2xtYCwgUmdsKTtcclxuXHR9IGNhdGNoKGUpIHtcclxuXHRcdG1hcCA9IG1vZC5yZ2xtLlJHTE0uUkdMTWFwLmJsYW5rKFJnbCk7XHJcblx0XHRtYXAucGFyZW50ID0gUmdsO1xyXG5cdFx0bWFwLl9sb2FkZWRGcm9tID0gZ291dCA9IGBtYXAke01hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIDB4ZmZmZmZmZmYpfS5yZ2xtYDtcclxuXHR9XHJcblx0XHJcblx0UmdsLndyaXRlRShgV3JpdGluZzogJHtnb3V0fWApO1xyXG5cdFJnbC53cml0ZUUoaGVscCgpKTtcclxuXHRcclxuXHRsZXQgYWNjOiBzdHJpbmcgPSBcIlwiLFxyXG5cdFx0aGlzdG9yeTogc3RyaW5nW10gPSBbXSxcclxuXHRcdGhpc3RpZHg6IG51bWJlciA9IDAsXHJcblx0XHRhY2lkeDogbnVtYmVyID0gMDtcclxuXHRcclxuXHRSZ2wub24oXCJyYXdjdHJsa2V5XCIsIGFzeW5jIChrLCBjLCBhLCBiKSA9PiB7XHJcblx0XHRpZiAoIW1vZC5yZ2wuUkdMLnNwZWNpYWxfa2V5cy5jdHJsQy5jb21wYXJlKGspKSBxdWl0KCk7XHJcblx0XHRlbHNlIGlmICghbW9kLnJnbC5SR0wuc3BlY2lhbF9rZXlzLmVudGVyLmNvbXBhcmUoaykpIHtcclxuXHRcdFx0aWYgKCFhY2MpIHJldHVybjtcclxuXHRcdFx0XHJcblx0XHRcdGF3YWl0IFJnbC5jbGVhcigtMSk7XHJcblx0XHRcdGF3YWl0IFJnbC5tb3ZlKDApO1xyXG5cdFx0XHRcclxuXHRcdFx0YXdhaXQgY29tbWFuZChhY2MpO1xyXG5cdFx0XHRcclxuXHRcdFx0aGlzdG9yeS5wdXNoKGFjYyk7XHJcblx0XHRcdHdoaWxlIChoaXN0b3J5Lmxlbmd0aCA+IDEwMCkgaGlzdG9yeS5zaGlmdCgpO1xyXG5cdFx0XHRcclxuXHRcdFx0YWNjID0gXCJcIjtcclxuXHRcdFx0YWNpZHggPSBoaXN0aWR4ID0gMDtcclxuXHRcdH0gZWxzZSBpZiAoIW1vZC5yZ2wuUkdMLnNwZWNpYWxfa2V5cy5iYWNrLmNvbXBhcmUoaykpIHtcclxuXHRcdFx0YWNjID0gYWNjLnNsaWNlKDAsIGFjYy5sZW5ndGggLSAxKTtcclxuXHRcdFx0YXdhaXQgUmdsLm1vdmUoLTEsIDAsIHRydWUpO1xyXG5cdFx0XHRSZ2wud3JpdGUoJyAnKTtcclxuXHRcdFx0YXdhaXQgUmdsLm1vdmUoLTEsIDAsIHRydWUpO1xyXG5cdFx0fSBlbHNlIGlmICghbW9kLnJnbC5SR0wuc3BlY2lhbF9rZXlzLnVwLmNvbXBhcmUoaykpIHtcclxuXHRcdFx0bW92ZUJ5KDAsIC0xKTtcclxuXHRcdH0gZWxzZSBpZiAoIW1vZC5yZ2wuUkdMLnNwZWNpYWxfa2V5cy5kb3duLmNvbXBhcmUoaykpIHtcclxuXHRcdFx0bW92ZUJ5KDAsIDEpO1xyXG5cdFx0fSBlbHNlIGlmICghbW9kLnJnbC5SR0wuc3BlY2lhbF9rZXlzLnJpZ2h0LmNvbXBhcmUoaykpIHtcclxuXHRcdFx0bW92ZUJ5KDEsIDApO1xyXG5cdFx0fSBlbHNlIGlmICghbW9kLnJnbC5SR0wuc3BlY2lhbF9rZXlzLmxlZnQuY29tcGFyZShrKSkge1xyXG5cdFx0XHRtb3ZlQnkoLTEsIDApO1xyXG5cdFx0fSBlbHNlIGlmICghbW9kLnJnbC5SR0wuc3BlY2lhbF9rZXlzLnNoaWZ0VXAuY29tcGFyZShrKSkge1xyXG5cdFx0XHRoaXN0aWR4ID0gaGlzdGlkeCA8PSBoaXN0b3J5Lmxlbmd0aCA/IChoaXN0aWR4ICsgMSkgOiBoaXN0aWR4O1xyXG5cdFx0XHRcclxuXHRcdFx0YWNjID0gaGlzdG9yeVtoaXN0b3J5Lmxlbmd0aCAtIGhpc3RpZHhdID8/IGFjYztcclxuXHRcdFx0XHJcblx0XHRcdGF3YWl0IFJnbC5jbGVhcigtMSk7XHJcblx0XHRcdGF3YWl0IFJnbC5tb3ZlKDApO1xyXG5cdFx0XHRSZ2wud3JpdGUoYWNjKTtcclxuXHRcdH0gZWxzZSBpZiAoIW1vZC5yZ2wuUkdMLnNwZWNpYWxfa2V5cy5zaGlmdERvd24uY29tcGFyZShrKSkge1xyXG5cdFx0XHRoaXN0aWR4ID0gaGlzdGlkeCA+IDAgPyAoaGlzdGlkeCAtIDEpIDogaGlzdGlkeDtcclxuXHRcdFx0XHJcblx0XHRcdGFjYyA9IGhpc3RvcnlbaGlzdG9yeS5sZW5ndGggLSBoaXN0aWR4XSA/PyBhY2M7XHJcblx0XHRcdFxyXG5cdFx0XHRhd2FpdCBSZ2wuY2xlYXIoLTEpO1xyXG5cdFx0XHRhd2FpdCBSZ2wubW92ZSgwKTtcclxuXHRcdFx0UmdsLndyaXRlKGFjYyk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRsZXQgczogc3RyaW5nID0gYi50b1N0cmluZygpO1xyXG5cdFx0XHRhY2MgKz0gcztcclxuXHRcdFx0UmdsLndyaXRlKHMpO1xyXG5cdFx0XHRhY2lkeCsrO1xyXG5cdFx0fVxyXG5cdH0pO1xyXG59OyAvL21hcFxyXG4iXX0=