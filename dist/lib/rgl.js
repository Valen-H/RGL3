/// <reference path="./RGLM.ts">
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.rglm = exports.rgl = void 0;
const tslib_1 = require("tslib");
const assert = tslib_1.__importStar(require("assert"));
const event = tslib_1.__importStar(require("events"));
const readline = tslib_1.__importStar(require("readline"));
const fs = tslib_1.__importStar(require("fs-extra"));
const os = tslib_1.__importStar(require("os"));
const path = tslib_1.__importStar(require("path"));
const rglm = tslib_1.__importStar(require("./RGLM"));
exports.rglm = rglm;
var rgl;
(function (rgl) {
    rgl.scrollUp = (by = 1) => `\x1b[${by}S`, rgl.scrollDown = (by = 1) => `\x1b[${by}T`, rgl.save = `\x1b7\x1b[s`, rgl.restore = `\x1b8\x1b[u`;
    class RGL extends event.EventEmitter {
        cfg;
        _bound = {
            sin: process.stdin,
            sout: process.stdout,
            serr: process.stderr,
            sinbind: null,
        };
        cursor = [0, 0];
        #_loadedFrom = "";
        static defaults = {
            description: "",
            entry: "./main.js",
            version: "0.1",
            mappings: "./mappings.js",
            name: process.title,
            "$schema": path.join(__dirname, "rglcfg.schema.json")
        };
        static special_keys = {
            ctrlC: Buffer.from("03", "hex"),
            ctrlV: Buffer.from("16", "hex"),
            up: Buffer.from("1b5b41", "hex"),
            down: Buffer.from("1b5b42", "hex"),
            right: Buffer.from("1b5b43", "hex"),
            left: Buffer.from("1b5b44", "hex"),
            enter: Buffer.from("0d", "hex"), //0a
        };
        constructor(cfg) {
            super();
            this.cfg = cfg;
            this.cfg = Object.assign(Object.assign(Object.create(null), RGL.defaults), cfg);
            assert.ok(this.cfg.name, "RGL 'name' must be provided in the config");
            this.cfg.entry = path.win32.resolve(this.cfg.entry ?? "./main.js");
            this.cfg.mappings = path.win32.resolve(this.cfg.mappings ?? "./mappings.js");
            //process.stdout.write(`\x1b]0;${this.cfg.name}\a`);
            process.title = this.cfg.name ?? process.title ?? "RGL";
            this.parseMappings();
        } //ctor
        get dimens() {
            return this.sout?.getWindowSize() ?? [0, 0];
        } //g-dimens
        get cDpt() {
            return this.colorDepth();
        } //g-cDpt
        get serr() {
            return this._bound.serr ?? this._bound.sout ?? process.stderr;
        } //g-serr
        get sout() {
            return this._bound.sout ?? process.stdout;
        } //g-sout
        get sin() {
            return this._bound.sin ?? process.stdin;
        } //g-sin
        parseMappings(from = this.cfg.mappings) {
            assert.ok(from, "'mappings' must be a valid path");
            delete require.cache[from];
            return rglm.RGLM.RGLMChunk.mappings = require(from);
        } //parseMappings
        capture(which = this.sin, bind = true, out = this.sout, err = this.serr) {
            assert.ok(which.isTTY && out.isTTY && err.isTTY, "Stream must be TTY");
            if ((which.isRaw && !bind) || (!which.isRaw && bind))
                which.setRawMode(bind);
            if (this._bound.sinbind && this._bound.sin) {
                this._bound.sin.removeListener("data", this._bound.sinbind);
                this._bound.sinbind = null;
            }
            if (which.isRaw) {
                which.on("data", this._bound.sinbind = (key) => {
                    this.emit("rawkey", key, key[0] == 0x1b, key.length > 1 ? key.slice(1) : key.slice(0));
                    this.emit("rawctrlkey", key, Buffer.from([(Array.from(key.values()).pop() ?? 0) + 0x61 - 1]), key.length > 1 && key[0] == 0x1b, key.length > 1 ? key.slice(1) : key.slice(0));
                    this.emit("key", key.toString("utf8"), key[0] == 0x1b, (key.length > 1 ? key.slice(1) : key.slice(0)).toString("utf8"));
                });
            }
            this._bound.sin = which;
            this._bound.sout = out;
            this._bound.serr = err;
            this.emit("debug", `TTY set to ${bind}`);
            return which.isRaw;
        } //capture
        static async load(from = "rglcfg.json") {
            if (typeof from == "string") {
                from = path.win32.resolve(from);
                let out = new RGL(JSON.parse((await fs.promises.readFile(from, {
                    encoding: "ascii",
                    flag: "r"
                }))));
                out.#_loadedFrom = from;
                return out;
            }
            else
                return new RGL(from);
        } //load
        async store(to = this.#_loadedFrom, repl, pad = 2) {
            assert.ok(to && typeof to == "string", "'config' must be a valid path");
            return await fs.writeJSON(to, this.cfg, {
                EOL: os.EOL,
                encoding: "ascii",
                mode: 0o775,
                spaces: pad,
                replacer: repl,
                flag: "w"
            });
        } //store
        exec(from = this.cfg.entry) {
            assert.ok(from, "'entry' must be a valid path");
            delete require.cache[from];
            require(from)(this, module);
        } //exec
        write(d, ...data) {
            if (d instanceof Uint8Array)
                d = d.join('');
            d = d.replaceAll('\t', ' '.repeat(4)).replaceAll(/((?<!\r)\n(?!\r)|(?<!\n)\r(?!\n)|\r\n|\n\r)/gmis, '\n');
            const chs = d.toString().split('\n');
            this.cursor[1] += chs.length - 1;
            this.cursor[0] = chs[chs.length - 1].length - 1;
            const out = this.sout.write(d);
            this.emit("write", d);
            if (!out)
                process.nextTick(() => this.sout.uncork());
            data.forEach(dt => this.write(dt));
            return out;
        } //write
        writeE(...data) {
            return this.write(data.shift(), ...data, os.EOL);
        } //writeE
        colorDepth(env = process.env) {
            return this.sout.getColorDepth(env);
        } //colorDepth
        async move(x, y, rel = false) {
            x = Math.max(x, 0) % this.dimens[0];
            if (y)
                y = Math.max(y, 0) % this.dimens[1];
            return new Promise((res, rej) => {
                let data;
                this.emit("move", x, y, rel);
                if (!rel) {
                    data = readline.cursorTo(this.sout, x, y, () => res(data));
                    this.cursor[0] = x;
                    this.cursor[1] = y ?? this.cursor[1];
                }
                else {
                    data = readline.moveCursor(this.sout, x, y ?? 0, () => res(data));
                    if (x)
                        this.cursor[0] += x;
                    if (y)
                        this.cursor[1] += y;
                }
            });
        } //move
        async clear(lines, dir = 0, rel) {
            return new Promise(async (res, rej) => {
                let out = true;
                if (!lines) {
                    this.move(0, 0, rel).then(() => {
                        out = readline.clearScreenDown(this.sout);
                        this.move(...this.cursor, false).then(() => res(out));
                    });
                }
                else if (typeof lines == "number" && lines < 0)
                    out = readline.clearLine(this.sout, dir, () => res(out));
                else if (typeof lines == "number") {
                    this.move(0, lines, rel).then(() => {
                        out = readline.clearLine(this.sout, dir);
                        this.move(...this.cursor, false).then(() => res(out));
                    });
                }
                else
                    return Promise.all(lines.map(l => this.clear(l, dir, rel))).then(bs => res(bs.every(b => b)), rej);
                this.emit("clear", lines, dir, rel, out);
            });
        } //clear
        emit(eventname, ...args) {
            return super.emit(eventname, ...args);
        } //emit
    } //RGL
    rgl.RGL = RGL;
})(rgl = exports.rgl || (exports.rgl = {})); //rgl
exports.default = rgl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmdsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL3JnbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxnQ0FBZ0M7QUFFaEMsWUFBWSxDQUFDOzs7O0FBV2IsdURBQWlDO0FBQ2pDLHNEQUFnQztBQUNoQywyREFBcUM7QUFFckMscURBQStCO0FBQy9CLCtDQUF5QjtBQUN6QixtREFBNkI7QUFDN0IscURBQStCO0FBd1B0QixvQkFBSTtBQXRQYixJQUFjLEdBQUcsQ0FvUGhCO0FBcFBELFdBQWMsR0FBRztJQUVILFlBQVEsR0FBRyxDQUFDLEtBQXNCLENBQUMsRUFBRSxFQUFFLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFDakUsY0FBVSxHQUFHLENBQUMsS0FBc0IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUN2RCxRQUFJLEdBQUcsYUFBYSxFQUNwQixXQUFPLEdBQUcsYUFBYSxDQUFDO0lBV3pCLE1BQWEsR0FBSSxTQUFRLEtBQUssQ0FBQyxZQUFZO1FBMENwQjtRQXhDZCxNQUFNLEdBS1Y7WUFDSCxHQUFHLEVBQUUsT0FBTyxDQUFDLEtBQUs7WUFDbEIsSUFBSSxFQUFFLE9BQU8sQ0FBQyxNQUFNO1lBQ3BCLElBQUksRUFBRSxPQUFPLENBQUMsTUFBTTtZQUNwQixPQUFPLEVBQUUsSUFBSTtTQUNiLENBQUM7UUFDRixNQUFNLEdBQXFCLENBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBRSxDQUFDO1FBQ3BDLFlBQVksR0FBVyxFQUFFLENBQUM7UUFFMUIsTUFBTSxDQUFVLFFBQVEsR0FBb0I7WUFDM0MsV0FBVyxFQUFFLEVBQUU7WUFDZixLQUFLLEVBQUUsV0FBVztZQUNsQixPQUFPLEVBQUUsS0FBSztZQUNkLFFBQVEsRUFBRSxlQUFlO1lBQ3pCLElBQUksRUFBRSxPQUFPLENBQUMsS0FBSztZQUNuQixTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsb0JBQW9CLENBQUM7U0FDckQs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QUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUMxQyxDQUFDLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQyxPQUFPO1FBV1QsSUFBSSxDQUFDLFNBQTBCLEVBQUUsR0FBRyxJQUFXO1lBQzlDLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUN2QyxDQUFDLENBQUMsTUFBTTtNQUVQLEtBQUs7SUFsT00sT0FBRyxNQWtPZixDQUFBO0FBRUYsQ0FBQyxFQXBQYSxHQUFHLEdBQUgsV0FBRyxLQUFILFdBQUcsUUFvUGhCLENBQUMsS0FBSztBQUlQLGtCQUFlLEdBQUcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuL1JHTE0udHNcIj5cclxuXHJcblwidXNlIHN0cmljdFwiO1xyXG5cclxuZXhwb3J0IHR5cGUgT3B0aW9uYWxzT25seTxUIGV4dGVuZHMgb2JqZWN0PiA9IFBpY2s8VCwgRXhjbHVkZTx7XHJcblx0W0sgaW4ga2V5b2YgVF0/OiBUIGV4dGVuZHMgUmVjb3JkPEssIFRbS10+ID8gbmV2ZXIgOiBLXHJcbn1ba2V5b2YgVF0sIHVuZGVmaW5lZD4+O1xyXG5leHBvcnQgdHlwZSBOb25PcHRpb25hbHM8VCBleHRlbmRzIG9iamVjdD4gPSB7XHJcblx0W2sgaW4ga2V5b2YgVF0tPzogdW5kZWZpbmVkIGV4dGVuZHMgVFtrXSA/IG5ldmVyIDoga1xyXG59W2tleW9mIFRdO1xyXG5leHBvcnQgdHlwZSBOdWxsYWJsZTxUPiA9IFQgfCBudWxsIHwgdW5kZWZpbmVkO1xyXG5leHBvcnQgdHlwZSBOdWxsYWJsZUFycmF5PFQ+ID0gWyBdIHwgVDtcclxuXHJcbmltcG9ydCAqIGFzIGFzc2VydCBmcm9tIFwiYXNzZXJ0XCI7XHJcbmltcG9ydCAqIGFzIGV2ZW50IGZyb20gXCJldmVudHNcIjtcclxuaW1wb3J0ICogYXMgcmVhZGxpbmUgZnJvbSBcInJlYWRsaW5lXCI7XHJcbmltcG9ydCAqIGFzIHR0eSBmcm9tIFwidHR5XCI7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xyXG5pbXBvcnQgKiBhcyBvcyBmcm9tIFwib3NcIjtcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xyXG5pbXBvcnQgKiBhcyByZ2xtIGZyb20gXCIuL1JHTE1cIjtcclxuXHJcbmV4cG9ydCBtb2R1bGUgcmdsIHtcclxuXHRcclxuXHRleHBvcnQgY29uc3Qgc2Nyb2xsVXAgPSAoYnk6IG51bWJlciB8IHN0cmluZyA9IDEpID0+IGBcXHgxYlske2J5fVNgLFxyXG5cdFx0c2Nyb2xsRG93biA9IChieTogbnVtYmVyIHwgc3RyaW5nID0gMSkgPT4gYFxceDFiWyR7Ynl9VGAsXHJcblx0XHRzYXZlID0gYFxceDFiN1xceDFiW3NgLFxyXG5cdFx0cmVzdG9yZSA9IGBcXHgxYjhcXHgxYlt1YDtcclxuXHRcclxuXHRleHBvcnQgaW50ZXJmYWNlIFJHTENmZyB7XHJcblx0XHRuYW1lOiBzdHJpbmc7XHJcblx0XHRkZXNjcmlwdGlvbj86IHN0cmluZztcclxuXHRcdGVudHJ5Pzogc3RyaW5nO1xyXG5cdFx0dmVyc2lvbj86IHN0cmluZztcclxuXHRcdG1hcHBpbmdzPzogc3RyaW5nO1xyXG5cdFx0XCIkc2NoZW1hXCI/OiBzdHJpbmc7XHJcblx0fSAvL1JHTENmZ1xyXG5cdFxyXG5cdGV4cG9ydCBjbGFzcyBSR0wgZXh0ZW5kcyBldmVudC5FdmVudEVtaXR0ZXIge1xyXG5cdFx0XHJcblx0XHRwcml2YXRlIF9ib3VuZDoge1xyXG5cdFx0XHRzaW4/OiB0dHkuUmVhZFN0cmVhbSxcclxuXHRcdFx0c291dD86IHR0eS5Xcml0ZVN0cmVhbSxcclxuXHRcdFx0c2Vycj86IHR0eS5Xcml0ZVN0cmVhbSxcclxuXHRcdFx0c2luYmluZD86IE51bGxhYmxlPChrZXk6IEJ1ZmZlcikgPT4gYW55PixcclxuXHRcdH0gPSB7XHJcblx0XHRcdHNpbjogcHJvY2Vzcy5zdGRpbixcclxuXHRcdFx0c291dDogcHJvY2Vzcy5zdGRvdXQsXHJcblx0XHRcdHNlcnI6IHByb2Nlc3Muc3RkZXJyLFxyXG5cdFx0XHRzaW5iaW5kOiBudWxsLFxyXG5cdFx0fTtcclxuXHRcdGN1cnNvcjogW251bWJlciwgbnVtYmVyXSA9IFsgMCwgMCBdO1xyXG5cdFx0I19sb2FkZWRGcm9tOiBzdHJpbmcgPSBcIlwiO1xyXG5cdFx0XHJcblx0XHRzdGF0aWMgcmVhZG9ubHkgZGVmYXVsdHM6IFBhcnRpYWw8UkdMQ2ZnPiA9IHtcclxuXHRcdFx0ZGVzY3JpcHRpb246IFwiXCIsXHJcblx0XHRcdGVudHJ5OiBcIi4vbWFpbi5qc1wiLFxyXG5cdFx0XHR2ZXJzaW9uOiBcIjAuMVwiLFxyXG5cdFx0XHRtYXBwaW5nczogXCIuL21hcHBpbmdzLmpzXCIsXHJcblx0XHRcdG5hbWU6IHByb2Nlc3MudGl0bGUsXHJcblx0XHRcdFwiJHNjaGVtYVwiOiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcInJnbGNmZy5zY2hlbWEuanNvblwiKVxyXG5cdFx0fTtcclxuXHRcdHN0YXRpYyByZWFkb25seSBzcGVjaWFsX2tleXM6IHtcclxuXHRcdFx0Y3RybEM6XHRcdFJlYWRvbmx5PE5vbk51bGxhYmxlPEJ1ZmZlcj4+O1xyXG5cdFx0XHRjdHJsVjpcdFx0UmVhZG9ubHk8Tm9uTnVsbGFibGU8QnVmZmVyPj47XHJcblx0XHRcdHVwOlx0XHRcdFJlYWRvbmx5PE5vbk51bGxhYmxlPEJ1ZmZlcj4+O1xyXG5cdFx0XHRkb3duOlx0XHRSZWFkb25seTxOb25OdWxsYWJsZTxCdWZmZXI+PjtcclxuXHRcdFx0cmlnaHQ6XHRcdFJlYWRvbmx5PE5vbk51bGxhYmxlPEJ1ZmZlcj4+O1xyXG5cdFx0XHRsZWZ0Olx0XHRSZWFkb25seTxOb25OdWxsYWJsZTxCdWZmZXI+PjtcclxuXHRcdFx0ZW50ZXI6XHRcdFJlYWRvbmx5PE5vbk51bGxhYmxlPEJ1ZmZlcj4+O1xyXG5cdFx0fSA9IHtcclxuXHRcdFx0Y3RybEM6XHRcdEJ1ZmZlci5mcm9tKFwiMDNcIixcdFx0XCJoZXhcIiksXHJcblx0XHRcdGN0cmxWOlx0XHRCdWZmZXIuZnJvbShcIjE2XCIsXHRcdFwiaGV4XCIpLFxyXG5cdFx0XHR1cDpcdFx0XHRCdWZmZXIuZnJvbShcIjFiNWI0MVwiLFx0XCJoZXhcIiksXHJcblx0XHRcdGRvd246XHRcdEJ1ZmZlci5mcm9tKFwiMWI1YjQyXCIsXHRcImhleFwiKSxcclxuXHRcdFx0cmlnaHQ6XHRcdEJ1ZmZlci5mcm9tKFwiMWI1YjQzXCIsXHRcImhleFwiKSxcclxuXHRcdFx0bGVmdDpcdFx0QnVmZmVyLmZyb20oXCIxYjViNDRcIixcdFwiaGV4XCIpLFxyXG5cdFx0XHRlbnRlcjpcdFx0QnVmZmVyLmZyb20oXCIwZFwiLFx0XHRcImhleFwiKSwgLy8wYVxyXG5cdFx0fTtcclxuXHRcdFxyXG5cdFx0Y29uc3RydWN0b3IocHJvdGVjdGVkIGNmZzogUkdMQ2ZnKSB7XHJcblx0XHRcdHN1cGVyKCk7XHJcblx0XHRcdFxyXG5cdFx0XHR0aGlzLmNmZyA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbihPYmplY3QuY3JlYXRlKG51bGwpLCBSR0wuZGVmYXVsdHMpLCBjZmcpO1xyXG5cdFx0XHRcclxuXHRcdFx0YXNzZXJ0Lm9rKHRoaXMuY2ZnLm5hbWUsIFwiUkdMICduYW1lJyBtdXN0IGJlIHByb3ZpZGVkIGluIHRoZSBjb25maWdcIik7XHJcblx0XHRcdFxyXG5cdFx0XHR0aGlzLmNmZy5lbnRyeVx0XHQ9IHBhdGgud2luMzIucmVzb2x2ZSh0aGlzLmNmZy5lbnRyeSA/PyBcIi4vbWFpbi5qc1wiKTtcclxuXHRcdFx0dGhpcy5jZmcubWFwcGluZ3NcdD0gcGF0aC53aW4zMi5yZXNvbHZlKHRoaXMuY2ZnLm1hcHBpbmdzID8/IFwiLi9tYXBwaW5ncy5qc1wiKTtcclxuXHRcdFx0XHJcblx0XHRcdC8vcHJvY2Vzcy5zdGRvdXQud3JpdGUoYFxceDFiXTA7JHt0aGlzLmNmZy5uYW1lfVxcYWApO1xyXG5cdFx0XHRwcm9jZXNzLnRpdGxlID0gdGhpcy5jZmcubmFtZSA/PyBwcm9jZXNzLnRpdGxlID8/IFwiUkdMXCI7XHJcblx0XHRcdFxyXG5cdFx0XHR0aGlzLnBhcnNlTWFwcGluZ3MoKTtcclxuXHRcdH0gLy9jdG9yXHJcblx0XHRcclxuXHRcdGdldCBkaW1lbnMoKTogW251bWJlciwgbnVtYmVyXSB8IFswLCAwXSB7XHJcblx0XHRcdHJldHVybiB0aGlzLnNvdXQ/LmdldFdpbmRvd1NpemUoKSA/PyBbMCwgMF07XHJcblx0XHR9IC8vZy1kaW1lbnNcclxuXHRcdGdldCBjRHB0KCk6IG51bWJlciB7XHJcblx0XHRcdHJldHVybiB0aGlzLmNvbG9yRGVwdGgoKTtcclxuXHRcdH0gLy9nLWNEcHRcclxuXHRcdGdldCBzZXJyKCk6IHR0eS5Xcml0ZVN0cmVhbSB7XHJcblx0XHRcdHJldHVybiB0aGlzLl9ib3VuZC5zZXJyID8/IHRoaXMuX2JvdW5kLnNvdXQgPz8gcHJvY2Vzcy5zdGRlcnI7XHJcblx0XHR9IC8vZy1zZXJyXHJcblx0XHRnZXQgc291dCgpOiB0dHkuV3JpdGVTdHJlYW0ge1xyXG5cdFx0XHRyZXR1cm4gdGhpcy5fYm91bmQuc291dCA/PyBwcm9jZXNzLnN0ZG91dDtcclxuXHRcdH0gLy9nLXNvdXRcclxuXHRcdGdldCBzaW4oKTogdHR5LlJlYWRTdHJlYW0ge1xyXG5cdFx0XHRyZXR1cm4gdGhpcy5fYm91bmQuc2luID8/IHByb2Nlc3Muc3RkaW47XHJcblx0XHR9IC8vZy1zaW5cclxuXHRcdFxyXG5cdFx0cGFyc2VNYXBwaW5ncyhmcm9tOiBOdWxsYWJsZTxzdHJpbmc+ID0gdGhpcy5jZmcubWFwcGluZ3MpIHtcclxuXHRcdFx0YXNzZXJ0Lm9rKGZyb20sIFwiJ21hcHBpbmdzJyBtdXN0IGJlIGEgdmFsaWQgcGF0aFwiKTtcclxuXHRcdFx0XHJcblx0XHRcdGRlbGV0ZSByZXF1aXJlLmNhY2hlW2Zyb21dO1xyXG5cdFx0XHRyZXR1cm4gcmdsbS5SR0xNLlJHTE1DaHVuay5tYXBwaW5ncyA9IHJlcXVpcmUoZnJvbSk7XHJcblx0XHR9IC8vcGFyc2VNYXBwaW5nc1xyXG5cdFx0XHJcblx0XHRjYXB0dXJlKHdoaWNoOiB0dHkuUmVhZFN0cmVhbSA9IHRoaXMuc2luLCBiaW5kID0gdHJ1ZSwgb3V0OiB0dHkuV3JpdGVTdHJlYW0gPSB0aGlzLnNvdXQsIGVycjogdHR5LldyaXRlU3RyZWFtID0gdGhpcy5zZXJyKTogYm9vbGVhbiB7XHJcblx0XHRcdGFzc2VydC5vayh3aGljaC5pc1RUWSAmJiBvdXQuaXNUVFkgJiYgZXJyLmlzVFRZLCBcIlN0cmVhbSBtdXN0IGJlIFRUWVwiKTtcclxuXHRcdFx0XHJcblx0XHRcdGlmICgod2hpY2guaXNSYXcgJiYgIWJpbmQpIHx8ICghd2hpY2guaXNSYXcgJiYgYmluZCkpIHdoaWNoLnNldFJhd01vZGUoYmluZCk7XHJcblx0XHRcdFxyXG5cdFx0XHRpZiAodGhpcy5fYm91bmQuc2luYmluZCAmJiB0aGlzLl9ib3VuZC5zaW4pIHtcclxuXHRcdFx0XHR0aGlzLl9ib3VuZC5zaW4hLnJlbW92ZUxpc3RlbmVyKFwiZGF0YVwiLCB0aGlzLl9ib3VuZC5zaW5iaW5kISk7XHJcblx0XHRcdFx0dGhpcy5fYm91bmQuc2luYmluZCA9IG51bGw7XHJcblx0XHRcdH1cclxuXHRcdFx0XHJcblx0XHRcdGlmICh3aGljaC5pc1Jhdykge1xyXG5cdFx0XHRcdHdoaWNoLm9uKFwiZGF0YVwiLCB0aGlzLl9ib3VuZC5zaW5iaW5kID0gKGtleTogQnVmZmVyKSA9PiB7XHJcblx0XHRcdFx0XHR0aGlzLmVtaXQoXCJyYXdrZXlcIiwga2V5LCBrZXlbMF0gPT0gMHgxYiwga2V5Lmxlbmd0aCA+IDEgPyBrZXkuc2xpY2UoMSkgOiBrZXkuc2xpY2UoMCkpO1xyXG5cdFx0XHRcdFx0dGhpcy5lbWl0KFwicmF3Y3RybGtleVwiLCBrZXksIEJ1ZmZlci5mcm9tKFsoQXJyYXkuZnJvbShrZXkudmFsdWVzKCkpLnBvcCgpID8/IDApICsgMHg2MSAtIDFdKSwga2V5Lmxlbmd0aCA+IDEgJiYga2V5WzBdID09IDB4MWIsIGtleS5sZW5ndGggPiAxID8ga2V5LnNsaWNlKDEpIDoga2V5LnNsaWNlKDApKTtcclxuXHRcdFx0XHRcdHRoaXMuZW1pdChcImtleVwiLCBrZXkudG9TdHJpbmcoXCJ1dGY4XCIpLCBrZXlbMF0gPT0gMHgxYiwgKGtleS5sZW5ndGggPiAxID8ga2V5LnNsaWNlKDEpIDoga2V5LnNsaWNlKDApKS50b1N0cmluZyhcInV0ZjhcIikpO1xyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9XHJcblx0XHRcdFxyXG5cdFx0XHR0aGlzLl9ib3VuZC5zaW4gPSB3aGljaDtcclxuXHRcdFx0dGhpcy5fYm91bmQuc291dCA9IG91dDtcclxuXHRcdFx0dGhpcy5fYm91bmQuc2VyciA9IGVycjtcclxuXHRcdFx0XHJcblx0XHRcdHRoaXMuZW1pdChcImRlYnVnXCIsIGBUVFkgc2V0IHRvICR7YmluZH1gKTtcclxuXHRcdFx0XHJcblx0XHRcdHJldHVybiB3aGljaC5pc1JhdztcclxuXHRcdH0gLy9jYXB0dXJlXHJcblx0XHRcclxuXHRcdHN0YXRpYyBhc3luYyBsb2FkKGZyb206IHN0cmluZyB8IFJHTENmZyA9IFwicmdsY2ZnLmpzb25cIik6IFByb21pc2U8UkdMPiB7XHJcblx0XHRcdGlmICh0eXBlb2YgZnJvbSA9PSBcInN0cmluZ1wiKSB7XHJcblx0XHRcdFx0ZnJvbSA9IHBhdGgud2luMzIucmVzb2x2ZShmcm9tKTtcclxuXHRcdFx0XHRcclxuXHRcdFx0XHRsZXQgb3V0ID0gbmV3IFJHTChKU09OLnBhcnNlKChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShmcm9tLCB7XHJcblx0XHRcdFx0XHRlbmNvZGluZzogXCJhc2NpaVwiLFxyXG5cdFx0XHRcdFx0ZmxhZzogXCJyXCJcclxuXHRcdFx0XHR9KSkpKTtcclxuXHRcdFx0XHRcclxuXHRcdFx0XHRvdXQuI19sb2FkZWRGcm9tID0gZnJvbTtcclxuXHRcdFx0XHRcclxuXHRcdFx0XHRyZXR1cm4gb3V0O1xyXG5cdFx0XHR9IGVsc2UgcmV0dXJuIG5ldyBSR0woZnJvbSk7XHJcblx0XHR9IC8vbG9hZFxyXG5cdFx0YXN5bmMgc3RvcmUodG86IHN0cmluZyA9IHRoaXMuI19sb2FkZWRGcm9tLCByZXBsPzogKCh0aGlzOiBhbnksIGtleTogc3RyaW5nLCB2YWx1ZTogbnVtYmVyKSA9PiBhbnkpLCBwYWQ6IG51bWJlciA9IDIpIHtcclxuXHRcdFx0YXNzZXJ0Lm9rKHRvICYmIHR5cGVvZiB0byA9PSBcInN0cmluZ1wiLCBcIidjb25maWcnIG11c3QgYmUgYSB2YWxpZCBwYXRoXCIpO1xyXG5cdFx0XHRcclxuXHRcdFx0cmV0dXJuIGF3YWl0IGZzLndyaXRlSlNPTih0bywgdGhpcy5jZmcsIHtcclxuXHRcdFx0XHRFT0w6IG9zLkVPTCxcclxuXHRcdFx0XHRlbmNvZGluZzogXCJhc2NpaVwiLFxyXG5cdFx0XHRcdG1vZGU6IDBvNzc1LFxyXG5cdFx0XHRcdHNwYWNlczogcGFkLFxyXG5cdFx0XHRcdHJlcGxhY2VyOiByZXBsLFxyXG5cdFx0XHRcdGZsYWc6IFwid1wiXHJcblx0XHRcdH0pO1xyXG5cdFx0fSAvL3N0b3JlXHJcblx0XHRcclxuXHRcdGV4ZWMoZnJvbTogTnVsbGFibGU8c3RyaW5nPiA9IHRoaXMuY2ZnLmVudHJ5KSB7XHJcblx0XHRcdGFzc2VydC5vayhmcm9tLCBcIidlbnRyeScgbXVzdCBiZSBhIHZhbGlkIHBhdGhcIik7XHJcblx0XHRcdFxyXG5cdFx0XHRkZWxldGUgcmVxdWlyZS5jYWNoZVtmcm9tXTtcclxuXHRcdFx0cmVxdWlyZShmcm9tKSh0aGlzLCBtb2R1bGUpO1xyXG5cdFx0fSAvL2V4ZWNcclxuXHRcdFxyXG5cdFx0d3JpdGUoZDogc3RyaW5nIHwgVWludDhBcnJheSwgLi4uZGF0YTogKHN0cmluZyB8IFVpbnQ4QXJyYXkpW10pOiBib29sZWFuIHtcclxuXHRcdFx0aWYgKGQgaW5zdGFuY2VvZiBVaW50OEFycmF5KSBkID0gZC5qb2luKCcnKTtcclxuXHRcdFx0XHJcblx0XHRcdGQgPSBkLnJlcGxhY2VBbGwoJ1xcdCcsICcgJy5yZXBlYXQoNCkpLnJlcGxhY2VBbGwoLygoPzwhXFxyKVxcbig/IVxccil8KD88IVxcbilcXHIoPyFcXG4pfFxcclxcbnxcXG5cXHIpL2dtaXMsICdcXG4nKTtcclxuXHRcdFx0XHJcblx0XHRcdGNvbnN0IGNoczogc3RyaW5nW10gPSBkLnRvU3RyaW5nKCkuc3BsaXQoJ1xcbicpO1xyXG5cdFx0XHRcclxuXHRcdFx0dGhpcy5jdXJzb3JbMV0gKz0gY2hzLmxlbmd0aCAtIDE7XHJcblx0XHRcdHRoaXMuY3Vyc29yWzBdID0gY2hzW2Nocy5sZW5ndGggLSAxXS5sZW5ndGggLSAxO1xyXG5cdFx0XHRcclxuXHRcdFx0Y29uc3Qgb3V0OiBib29sZWFuID0gdGhpcy5zb3V0LndyaXRlKGQpO1xyXG5cdFx0XHRcclxuXHRcdFx0dGhpcy5lbWl0KFwid3JpdGVcIiwgZCk7XHJcblx0XHRcdFxyXG5cdFx0XHRpZiAoIW91dCkgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB0aGlzLnNvdXQudW5jb3JrKCkpO1xyXG5cdFx0XHRcclxuXHRcdFx0ZGF0YS5mb3JFYWNoKGR0ID0+IHRoaXMud3JpdGUoZHQpKTtcclxuXHRcdFx0XHJcblx0XHRcdHJldHVybiBvdXQ7XHJcblx0XHR9IC8vd3JpdGVcclxuXHRcdHdyaXRlRSguLi5kYXRhOiAoc3RyaW5nIHwgVWludDhBcnJheSlbXSkge1xyXG5cdFx0XHRyZXR1cm4gdGhpcy53cml0ZShkYXRhLnNoaWZ0KCkhLCAuLi5kYXRhLCBvcy5FT0wpO1xyXG5cdFx0fSAvL3dyaXRlRVxyXG5cdFx0XHJcblx0XHRjb2xvckRlcHRoKGVudjogTm9kZUpTLlByb2Nlc3NFbnYgPSBwcm9jZXNzLmVudik6IG51bWJlciB7XHJcblx0XHRcdHJldHVybiB0aGlzLnNvdXQuZ2V0Q29sb3JEZXB0aChlbnYpO1xyXG5cdFx0fSAvL2NvbG9yRGVwdGhcclxuXHRcdFxyXG5cdFx0YXN5bmMgbW92ZSh4OiBudW1iZXIsIHk6IG51bWJlciB8IHVuZGVmaW5lZCwgcmVsOiBib29sZWFuID0gZmFsc2UpIHtcclxuXHRcdFx0eCA9IE1hdGgubWF4KHgsIDApICUgdGhpcy5kaW1lbnNbMF07XHJcblx0XHRcdGlmICh5KSB5ID0gTWF0aC5tYXgoeSwgMCkgJSB0aGlzLmRpbWVuc1sxXTtcclxuXHRcdFx0XHJcblx0XHRcdHJldHVybiBuZXcgUHJvbWlzZSgocmVzLCByZWopID0+IHtcclxuXHRcdFx0XHRsZXQgZGF0YTogYm9vbGVhbjtcclxuXHRcdFx0XHRcclxuXHRcdFx0XHR0aGlzLmVtaXQoXCJtb3ZlXCIsIHgsIHksIHJlbCk7XHJcblx0XHRcdFx0XHJcblx0XHRcdFx0aWYgKCFyZWwpIHtcclxuXHRcdFx0XHRcdGRhdGEgPSByZWFkbGluZS5jdXJzb3JUbyh0aGlzLnNvdXQsIHgsIHksICgpID0+IHJlcyhkYXRhKSk7XHJcblx0XHRcdFx0XHR0aGlzLmN1cnNvclswXSA9IHg7XHJcblx0XHRcdFx0XHR0aGlzLmN1cnNvclsxXSA9IHkgPz8gdGhpcy5jdXJzb3JbMV07XHJcblx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdGRhdGEgPSByZWFkbGluZS5tb3ZlQ3Vyc29yKHRoaXMuc291dCwgeCwgeSA/PyAwLCAoKSA9PiByZXMoZGF0YSkpO1xyXG5cdFx0XHRcdFx0aWYgKHgpIHRoaXMuY3Vyc29yWzBdICs9IHg7XHJcblx0XHRcdFx0XHRpZiAoeSkgdGhpcy5jdXJzb3JbMV0gKz0geTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pO1xyXG5cdFx0fSAvL21vdmVcclxuXHRcdGFzeW5jIGNsZWFyKGxpbmVzPzogbnVtYmVyW10gfCBudW1iZXIsIGRpcjogdHR5LkRpcmVjdGlvbiA9IDAsIHJlbD86IGJvb2xlYW4pOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuXHRcdFx0cmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXMsIHJlaikgPT4ge1xyXG5cdFx0XHRcdGxldCBvdXQ6IGJvb2xlYW4gPSB0cnVlO1xyXG5cdFx0XHRcdFxyXG5cdFx0XHRcdGlmICghbGluZXMpIHtcclxuXHRcdFx0XHRcdHRoaXMubW92ZSgwLCAwLCByZWwpLnRoZW4oKCkgPT4ge1xyXG5cdFx0XHRcdFx0XHRvdXQgPSByZWFkbGluZS5jbGVhclNjcmVlbkRvd24odGhpcy5zb3V0KTtcclxuXHRcdFx0XHRcdFx0dGhpcy5tb3ZlKC4uLnRoaXMuY3Vyc29yLCBmYWxzZSkudGhlbigoKSA9PiByZXMob3V0KSk7XHJcblx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHR9IGVsc2UgaWYgKHR5cGVvZiBsaW5lcyA9PSBcIm51bWJlclwiICYmIGxpbmVzIDwgMClcclxuXHRcdFx0XHRcdG91dCA9IHJlYWRsaW5lLmNsZWFyTGluZSh0aGlzLnNvdXQsIGRpciwgKCkgPT4gcmVzKG91dCkpO1xyXG5cdFx0XHRcdGVsc2UgaWYgKHR5cGVvZiBsaW5lcyA9PSBcIm51bWJlclwiKSB7XHJcblx0XHRcdFx0XHR0aGlzLm1vdmUoMCwgbGluZXMsIHJlbCkudGhlbigoKSA9PiB7XHJcblx0XHRcdFx0XHRcdG91dCA9IHJlYWRsaW5lLmNsZWFyTGluZSh0aGlzLnNvdXQsIGRpcik7XHJcblx0XHRcdFx0XHRcdHRoaXMubW92ZSguLi50aGlzLmN1cnNvciwgZmFsc2UpLnRoZW4oKCkgPT4gcmVzKG91dCkpO1xyXG5cdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0fSBlbHNlXHJcblx0XHRcdFx0XHRyZXR1cm4gUHJvbWlzZS5hbGwobGluZXMubWFwKGwgPT4gdGhpcy5jbGVhcihsLCBkaXIsIHJlbCkpKS50aGVuKGJzID0+IHJlcyhicy5ldmVyeShiID0+IGIpKSwgcmVqKTtcclxuXHRcdFx0XHRcclxuXHRcdFx0XHR0aGlzLmVtaXQoXCJjbGVhclwiLCBsaW5lcywgZGlyLCByZWwsIG91dCk7XHJcblx0XHRcdH0pO1xyXG5cdFx0fSAvL2NsZWFyXHJcblx0XHRcclxuXHRcdGVtaXQoZXZlbnRuYW1lOiBcImxvZ1wiLCAuLi5hcmdzOiBhbnlbXSk6IGFueTtcclxuXHRcdGVtaXQoZXZlbnRuYW1lOiBcImRlYnVnXCIsIC4uLmFyZ3M6IGFueVtdKTogYW55O1xyXG5cdFx0ZW1pdChldmVudG5hbWU6IFwiY2xlYXJcIiwgbGluZXM6IG51bWJlciwgZGlyOiB0dHkuRGlyZWN0aW9uLCByZWw6IGJvb2xlYW4sIG91dDogYm9vbGVhbik6IGFueTtcclxuXHRcdGVtaXQoZXZlbnRuYW1lOiBcIndyaXRlXCIsIGQ6IHN0cmluZyB8IFVpbnQ4QXJyYXkpOiBzdHJpbmc7XHJcblx0XHRlbWl0KGV2ZW50bmFtZTogXCJtb3ZlXCIsIHg6IG51bWJlciwgeTogbnVtYmVyLCByZWw6IGJvb2xlYW4pOiBib29sZWFuO1xyXG5cdFx0ZW1pdChldmVudG5hbWU6IFwia2V5XCIsIGtleTogc3RyaW5nLCBpc2FsdDogYm9vbGVhbiwgczogc3RyaW5nKTogc3RyaW5nO1xyXG5cdFx0ZW1pdChldmVudG5hbWU6IFwicmF3a2V5XCIsIGtleTogQnVmZmVyLCBpc2FsdDogYm9vbGVhbiwgczogQnVmZmVyKTogQnVmZmVyO1xyXG5cdFx0ZW1pdChldmVudG5hbWU6IFwicmF3Y3RybGtleVwiLCBrZXk6IEJ1ZmZlciwgY3RybGtleTogQnVmZmVyLCBpc2FsdDogYm9vbGVhbiwgczogQnVmZmVyKTogQnVmZmVyO1xyXG5cdFx0ZW1pdChldmVudG5hbWU6IHN0cmluZyB8IHN5bWJvbCwgLi4uYXJnczogYW55W10pOiBib29sZWFuO1xyXG5cdFx0ZW1pdChldmVudG5hbWU6IHN0cmluZyB8IHN5bWJvbCwgLi4uYXJnczogYW55W10pOiBhbnkge1xyXG5cdFx0XHRyZXR1cm4gc3VwZXIuZW1pdChldmVudG5hbWUsIC4uLmFyZ3MpO1xyXG5cdFx0fSAvL2VtaXRcclxuXHRcdFxyXG5cdH0gLy9SR0xcclxuXHRcclxufSAvL3JnbFxyXG5cclxuZXhwb3J0IHsgcmdsbSB9O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgcmdsO1xyXG4iXX0=