"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RGLM = void 0;
const tslib_1 = require("tslib");
const assert = tslib_1.__importStar(require("assert"));
const fs = tslib_1.__importStar(require("fs-extra"));
const path = tslib_1.__importStar(require("path"));
var RGLM;
(function (RGLM) {
    RGLM.MAGIC = Buffer.from("RGL\0", "ascii");
    class RGLMChunk {
        chr;
        fg;
        bg;
        st;
        cust;
        static #idcntr = 0;
        static mappings;
        _id = RGLMChunk.#idcntr++;
        constructor(chr, fg, bg, st, cust) {
            this.chr = chr;
            this.fg = fg;
            this.bg = bg;
            this.st = st;
            this.cust = cust;
            assert.ok(Buffer.from(chr, "ascii").length <= 4 &&
                fg >= 0 && fg < 0xff &&
                bg >= 0 && bg < 0xff &&
                st >= 0 && st < 0xff &&
                cust >= 0 && cust < 0xff, "Bad Chunk");
        } //ctor
        get pack() {
            return Buffer.concat([Buffer.from(this.chr, "ascii"), Buffer.from([this.fg, this.bg, this.st, this.cust])], 8);
        } //g-pack
        static blank() {
            return new RGLMChunk('', 0xff, 0xff, 0xff, 0xff);
        } //blank
        static parse(buf) {
            return new RGLMChunk(buf.slice(0, 4).toString(), buf[4], buf[5], buf[6], buf[7]);
        } //parse
        print() {
            const fg = RGLMChunk.mappings.fg[this.fg] ?? ((s) => s), bg = RGLMChunk.mappings.bg[this.bg] ?? ((s) => s), st = RGLMChunk.mappings.st[this.st] ?? ((s) => s), cust = RGLMChunk.mappings.cust[this.cust] ?? ((s) => s);
            return cust(st(fg(bg(this.chr))));
        } //print
    } //RGLMChunk
    RGLM.RGLMChunk = RGLMChunk;
    class RGLMap {
        dimens;
        static RGLMChunk = RGLMChunk;
        chunks = [];
        #_loadedFrom = "";
        constructor(dimens = [0, 0]) {
            this.dimens = dimens;
            assert.ok(dimens instanceof Array && dimens.length == 2);
            this.dimens = dimens.map(d => Number(d));
        } //ctor
        static async parse(from) {
            assert.ok(from, "'from' must be provided");
            from = path.resolve(from);
            const dat = await fs.promises.readFile(from, {
                flag: "r"
            }), end = Buffer.from("0000000000000000", "hex");
            assert.ok(dat.length >= 8 && !dat.slice(0, 4).compare(Buffer.from("RGL\0", "ascii")), "Broken RGLM");
            let map = new RGLMap([dat.slice(4, 6).readUInt16LE(), dat.slice(6, 8).readUInt16LE()]), chk, i = 8, passing = true;
            map.#_loadedFrom = from;
            if (dat.length > 8) {
                do {
                    if (i + 8 > dat.length)
                        throw "Broken RGLM";
                    chk = dat.slice(i, i + 8);
                    if (!chk.compare(end)) {
                        map.chunks.push(RGLMap.RGLMChunk.parse(chk));
                    }
                    else
                        passing = false;
                } while (passing);
            }
            return map;
        } //parse
        async store(to = this.#_loadedFrom) {
            assert.ok(to && typeof to == "string", "'destination' must be a valid path");
            return await fs.promises.writeFile(to, this.pack, {
                encoding: "binary",
                flag: "w",
                mode: 0o775
            });
        } //store
        get pack() {
            return Buffer.concat([RGLM.MAGIC, Buffer.from(this.dimens), ...this.chunks.map(c => c.pack)], (this.chunks.length + 1) * 8);
        } //g-pack
    } //RGLMap
    RGLM.RGLMap = RGLMap;
})(RGLM = exports.RGLM || (exports.RGLM = {})); //RGLM
exports.default = RGLM;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUkdMTS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9SR0xNLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7OztBQUViLHVEQUFpQztBQUNqQyxxREFBK0I7QUFDL0IsbURBQTZCO0FBRTdCLElBQWMsSUFBSSxDQWdIakI7QUFoSEQsV0FBYyxJQUFJO0lBSUosVUFBSyxHQUEyQixNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQTJCLENBQUM7SUFFckcsTUFBYSxTQUFTO1FBYUY7UUFBb0I7UUFBbUI7UUFBbUI7UUFBbUI7UUFYaEcsTUFBTSxDQUFDLE9BQU8sR0FBVyxDQUFDLENBQUM7UUFFM0IsTUFBTSxDQUFDLFFBQVEsQ0FLYjtRQUVGLEdBQUcsR0FBVyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFbEMsWUFBbUIsR0FBVyxFQUFTLEVBQVUsRUFBUyxFQUFVLEVBQVMsRUFBVSxFQUFTLElBQVk7WUFBekYsUUFBRyxHQUFILEdBQUcsQ0FBUTtZQUFTLE9BQUUsR0FBRixFQUFFLENBQVE7WUFBUyxPQUFFLEdBQUYsRUFBRSxDQUFRO1lBQVMsT0FBRSxHQUFGLEVBQUUsQ0FBUTtZQUFTLFNBQUksR0FBSixJQUFJLENBQVE7WUFDM0csTUFBTSxDQUFDLEVBQUUsQ0FDUixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQztnQkFDckMsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSTtnQkFDcEIsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSTtnQkFDcEIsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSTtnQkFDcEIsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLEdBQUcsSUFBSSxFQUN6QixXQUFXLENBQUMsQ0FBQztRQUNkLENBQUMsQ0FBQyxNQUFNO1FBRVIsSUFBSSxJQUFJO1lBQ1AsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBYSxDQUFDO1FBQzVILENBQUMsQ0FBQyxRQUFRO1FBRVYsTUFBTSxDQUFDLEtBQUs7WUFDWCxPQUFPLElBQUksU0FBUyxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUMsT0FBTztRQUVULE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBdUI7WUFDbkMsT0FBTyxJQUFJLFNBQVMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRixDQUFDLENBQUMsT0FBTztRQUVULEtBQUs7WUFDSixNQUFNLEVBQUUsR0FBMkIsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFLLENBQUMsQ0FBQyxDQUFTLEVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUMvRixFQUFFLEdBQTJCLFNBQVMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSyxDQUFDLENBQUMsQ0FBUyxFQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFDMUYsRUFBRSxHQUEyQixTQUFTLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENB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SyxDQUFDO2lCQUN2QixRQUFPLE9BQU8sRUFBRTthQUNqQjtZQUVELE9BQU8sR0FBRyxDQUFDO1FBQ1osQ0FBQyxDQUFDLE9BQU87UUFFVCxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQWEsSUFBSSxDQUFDLFlBQVk7WUFDekMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksT0FBTyxFQUFFLElBQUksUUFBUSxFQUFFLG9DQUFvQyxDQUFDLENBQUM7WUFFN0UsT0FBTyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUNqRCxRQUFRLEVBQUUsUUFBUTtnQkFDbEIsSUFBSSxFQUFFLEdBQUc7Z0JBQ1QsSUFBSSxFQUFFLEtBQUs7YUFDWCxDQUFDLENBQUM7UUFDSixDQUFDLENBQUMsT0FBTztRQUVULElBQUksSUFBSTtZQUNQLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDN0gsQ0FBQyxDQUFDLFFBQVE7TUFFVCxRQUFRO0lBM0RHLFdBQU0sU0EyRGxCLENBQUE7QUFDRixDQUFDLEVBaEhhLElBQUksR0FBSixZQUFJLEtBQUosWUFBSSxRQWdIakIsQ0FBQyxNQUFNO0FBRVIsa0JBQWUsSUFBSSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG5pbXBvcnQgKiBhcyBhc3NlcnQgZnJvbSBcImFzc2VydFwiO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xyXG5cclxuZXhwb3J0IG1vZHVsZSBSR0xNIHtcclxuXHRcclxuXHRleHBvcnQgdHlwZSBDaHVua0J1ZiA9IEJ1ZmZlciAmIHsgbGVuZ3RoOiA4IH07XHJcblx0XHJcblx0ZXhwb3J0IGNvbnN0IE1BR0lDOiBCdWZmZXIgJiB7IGxlbmd0aDogNCB9ID0gQnVmZmVyLmZyb20oXCJSR0xcXDBcIiwgXCJhc2NpaVwiKSBhcyBCdWZmZXIgJiB7IGxlbmd0aDogNCB9O1xyXG5cdFxyXG5cdGV4cG9ydCBjbGFzcyBSR0xNQ2h1bmsge1xyXG5cdFx0XHJcblx0XHRzdGF0aWMgI2lkY250cjogbnVtYmVyID0gMDtcclxuXHRcdFxyXG5cdFx0c3RhdGljIG1hcHBpbmdzOiB7XHJcblx0XHRcdGZnOlx0XHQoKHM6IHN0cmluZykgPT4gc3RyaW5nKVtdO1xyXG5cdFx0XHRiZzpcdFx0KChzOiBzdHJpbmcpID0+IHN0cmluZylbXTtcclxuXHRcdFx0c3Q6XHRcdCgoczogc3RyaW5nKSA9PiBzdHJpbmcpW107XHJcblx0XHRcdGN1c3Q6XHQoKHM6IHN0cmluZykgPT4gc3RyaW5nKVtdO1xyXG5cdFx0fTtcclxuXHRcdFxyXG5cdFx0X2lkOiBudW1iZXIgPSBSR0xNQ2h1bmsuI2lkY250cisrO1xyXG5cdFx0XHJcblx0XHRjb25zdHJ1Y3RvcihwdWJsaWMgY2hyOiBzdHJpbmcsIHB1YmxpYyBmZzogbnVtYmVyLCBwdWJsaWMgYmc6IG51bWJlciwgcHVibGljIHN0OiBudW1iZXIsIHB1YmxpYyBjdXN0OiBudW1iZXIpIHtcclxuXHRcdFx0YXNzZXJ0Lm9rKFxyXG5cdFx0XHRcdEJ1ZmZlci5mcm9tKGNociwgXCJhc2NpaVwiKS5sZW5ndGggPD0gNCAmJlxyXG5cdFx0XHRcdGZnID49IDAgJiYgZmcgPCAweGZmICYmXHJcblx0XHRcdFx0YmcgPj0gMCAmJiBiZyA8IDB4ZmYgJiZcclxuXHRcdFx0XHRzdCA+PSAwICYmIHN0IDwgMHhmZiAmJlxyXG5cdFx0XHRcdGN1c3QgPj0gMCAmJiBjdXN0IDwgMHhmZixcclxuXHRcdFx0XCJCYWQgQ2h1bmtcIik7XHJcblx0XHR9IC8vY3RvclxyXG5cdFx0XHJcblx0XHRnZXQgcGFjaygpOiBDaHVua0J1ZiB7XHJcblx0XHRcdHJldHVybiBCdWZmZXIuY29uY2F0KFtCdWZmZXIuZnJvbSh0aGlzLmNociwgXCJhc2NpaVwiKSwgQnVmZmVyLmZyb20oW3RoaXMuZmcsIHRoaXMuYmcsIHRoaXMuc3QsIHRoaXMuY3VzdF0pXSwgOCkgYXMgQ2h1bmtCdWY7XHJcblx0XHR9IC8vZy1wYWNrXHJcblx0XHRcclxuXHRcdHN0YXRpYyBibGFuaygpOiBSR0xNQ2h1bmsge1xyXG5cdFx0XHRyZXR1cm4gbmV3IFJHTE1DaHVuaygnJywgMHhmZiwgMHhmZiwgMHhmZiwgMHhmZik7XHJcblx0XHR9IC8vYmxhbmtcclxuXHRcdFxyXG5cdFx0c3RhdGljIHBhcnNlKGJ1ZjogUmVhZG9ubHk8Q2h1bmtCdWY+KTogUkdMTUNodW5rIHtcclxuXHRcdFx0cmV0dXJuIG5ldyBSR0xNQ2h1bmsoYnVmLnNsaWNlKDAsIDQpLnRvU3RyaW5nKCksIGJ1Zls0XSwgYnVmWzVdLCBidWZbNl0sIGJ1Zls3XSk7XHJcblx0XHR9IC8vcGFyc2VcclxuXHRcdFxyXG5cdFx0cHJpbnQoKTogc3RyaW5nIHtcclxuXHRcdFx0Y29uc3QgZmc6XHRcdChzOiBzdHJpbmcpID0+IHN0cmluZyA9IFJHTE1DaHVuay5tYXBwaW5ncy5mZ1t0aGlzLmZnXVx0XHQ/PyAoKHM6IHN0cmluZyk6IHN0cmluZyA9PiBzKSxcclxuXHRcdFx0XHRiZzpcdFx0KHM6IHN0cmluZykgPT4gc3RyaW5nID0gUkdMTUNodW5rLm1hcHBpbmdzLmJnW3RoaXMuYmddXHRcdD8/ICgoczogc3RyaW5nKTogc3RyaW5nID0+IHMpLFxyXG5cdFx0XHRcdHN0Olx0XHQoczogc3RyaW5nKSA9PiBzdHJpbmcgPSBSR0xNQ2h1bmsubWFwcGluZ3Muc3RbdGhpcy5zdF1cdFx0Pz8gKChzOiBzdHJpbmcpOiBzdHJpbmcgPT4gcyksXHJcblx0XHRcdFx0Y3VzdDpcdChzOiBzdHJpbmcpID0+IHN0cmluZyA9IFJHTE1DaHVuay5tYXBwaW5ncy5jdXN0W3RoaXMuY3VzdF1cdD8/ICgoczogc3RyaW5nKTogc3RyaW5nID0+IHMpO1xyXG5cdFx0XHRcclxuXHRcdFx0cmV0dXJuIGN1c3Qoc3QoZmcoYmcodGhpcy5jaHIpKSkpO1xyXG5cdFx0fSAvL3ByaW50XHJcblx0XHRcclxuXHR9IC8vUkdMTUNodW5rXHJcblxyXG5cdGV4cG9ydCBjbGFzcyBSR0xNYXAge1xyXG5cdFx0c3RhdGljIFJHTE1DaHVuazogdHlwZW9mIFJHTE1DaHVuayA9IFJHTE1DaHVuaztcclxuXHRcdFxyXG5cdFx0cHJvdGVjdGVkIGNodW5rczogUkdMTUNodW5rW10gPSBbIF07XHJcblx0XHQjX2xvYWRlZEZyb206IHN0cmluZyA9IFwiXCI7XHJcblx0XHRcclxuXHRcdGNvbnN0cnVjdG9yKHByb3RlY3RlZCBkaW1lbnM6IFtudW1iZXIsIG51bWJlcl0gPSBbIDAsIDAgXSkge1xyXG5cdFx0XHRhc3NlcnQub2soZGltZW5zIGluc3RhbmNlb2YgQXJyYXkgJiYgZGltZW5zLmxlbmd0aCA9PSAyKTtcclxuXHRcdFx0XHJcblx0XHRcdHRoaXMuZGltZW5zID0gZGltZW5zLm1hcChkID0+IE51bWJlcihkKSkgYXMgW251bWJlciwgbnVtYmVyXTtcclxuXHRcdH0gLy9jdG9yXHJcblx0XHRcclxuXHRcdHN0YXRpYyBhc3luYyBwYXJzZShmcm9tOiBzdHJpbmcpOiBQcm9taXNlPFJHTE1hcD4ge1xyXG5cdFx0XHRhc3NlcnQub2soZnJvbSwgXCInZnJvbScgbXVzdCBiZSBwcm92aWRlZFwiKTtcclxuXHRcdFx0XHJcblx0XHRcdGZyb20gPSBwYXRoLnJlc29sdmUoZnJvbSk7XHJcblx0XHRcdGNvbnN0IGRhdDogQnVmZmVyID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoZnJvbSwge1xyXG5cdFx0XHRcdGZsYWc6IFwiclwiXHJcblx0XHRcdH0pLFxyXG5cdFx0XHRlbmQ6IEJ1ZmZlciA9IEJ1ZmZlci5mcm9tKFwiMDAwMDAwMDAwMDAwMDAwMFwiLCBcImhleFwiKTtcclxuXHRcdFx0XHJcblx0XHRcdGFzc2VydC5vayhkYXQubGVuZ3RoID49IDggJiYgIWRhdC5zbGljZSgwLCA0KS5jb21wYXJlKEJ1ZmZlci5mcm9tKFwiUkdMXFwwXCIsIFwiYXNjaWlcIikpLCBcIkJyb2tlbiBSR0xNXCIpO1xyXG5cdFx0XHRcclxuXHRcdFx0bGV0IG1hcCA9IG5ldyBSR0xNYXAoW2RhdC5zbGljZSg0LCA2KS5yZWFkVUludDE2TEUoKSwgZGF0LnNsaWNlKDYsIDgpLnJlYWRVSW50MTZMRSgpXSksXHJcblx0XHRcdFx0Y2hrOiBDaHVua0J1ZixcclxuXHRcdFx0XHRpOiBudW1iZXIgPSA4LFxyXG5cdFx0XHRcdHBhc3Npbmc6IGJvb2xlYW4gPSB0cnVlO1xyXG5cdFx0XHRcclxuXHRcdFx0bWFwLiNfbG9hZGVkRnJvbSA9IGZyb207XHJcblx0XHRcdFxyXG5cdFx0XHRpZiAoZGF0Lmxlbmd0aCA+IDgpIHtcclxuXHRcdFx0XHRkbyB7XHJcblx0XHRcdFx0XHRpZiAoaSArIDggPiBkYXQubGVuZ3RoKSB0aHJvdyBcIkJyb2tlbiBSR0xNXCI7XHJcblx0XHRcdFx0XHRcclxuXHRcdFx0XHRcdGNoayA9IGRhdC5zbGljZShpLCBpICsgOCkgYXMgQ2h1bmtCdWY7XHJcblx0XHRcdFx0XHRcclxuXHRcdFx0XHRcdGlmICghY2hrLmNvbXBhcmUoZW5kKSkge1xyXG5cdFx0XHRcdFx0XHRtYXAuY2h1bmtzLnB1c2goUkdMTWFwLlJHTE1DaHVuay5wYXJzZShjaGspKTtcclxuXHRcdFx0XHRcdH0gZWxzZSBwYXNzaW5nID0gZmFsc2U7XHJcblx0XHRcdFx0fSB3aGlsZShwYXNzaW5nKTtcclxuXHRcdFx0fVxyXG5cdFx0XHRcclxuXHRcdFx0cmV0dXJuIG1hcDtcclxuXHRcdH0gLy9wYXJzZVxyXG5cdFx0XHJcblx0XHRhc3luYyBzdG9yZSh0bzogc3RyaW5nID0gdGhpcy4jX2xvYWRlZEZyb20pIHtcclxuXHRcdFx0YXNzZXJ0Lm9rKHRvICYmIHR5cGVvZiB0byA9PSBcInN0cmluZ1wiLCBcIidkZXN0aW5hdGlvbicgbXVzdCBiZSBhIHZhbGlkIHBhdGhcIik7XHJcblx0XHRcdFxyXG5cdFx0XHRyZXR1cm4gYXdhaXQgZnMucHJvbWlzZXMud3JpdGVGaWxlKHRvLCB0aGlzLnBhY2ssIHtcclxuXHRcdFx0XHRlbmNvZGluZzogXCJiaW5hcnlcIixcclxuXHRcdFx0XHRmbGFnOiBcIndcIixcclxuXHRcdFx0XHRtb2RlOiAwbzc3NVxyXG5cdFx0XHR9KTtcclxuXHRcdH0gLy9zdG9yZVxyXG5cdFx0XHJcblx0XHRnZXQgcGFjaygpOiBCdWZmZXIge1xyXG5cdFx0XHRyZXR1cm4gQnVmZmVyLmNvbmNhdChbUkdMTS5NQUdJQywgQnVmZmVyLmZyb20odGhpcy5kaW1lbnMpLCAuLi50aGlzLmNodW5rcy5tYXAoYyA9PiBjLnBhY2spXSwgKHRoaXMuY2h1bmtzLmxlbmd0aCArIDEpICogOCk7XHJcblx0XHR9IC8vZy1wYWNrXHJcblx0XHRcclxuXHR9IC8vUkdMTWFwXHJcbn0gLy9SR0xNXHJcblxyXG5leHBvcnQgZGVmYXVsdCBSR0xNO1xyXG4iXX0=